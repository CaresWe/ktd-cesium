# å·¥ä½œæµé…ç½®éªŒè¯
name: Workflow Validation

on:
  push:
    branches: [main, develop]
    paths:
      - '.github/workflows/**'
      - '.github/**'
  pull_request:
    paths:
      - '.github/workflows/**'
      - '.github/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate workflow files
        run: |
          # æ£€æŸ¥æ‰€æœ‰å·¥ä½œæµæ–‡ä»¶çš„è¯­æ³•
          for workflow in .github/workflows/*.yml; do
            echo "ðŸ” éªŒè¯ $workflow..."
            if ! yamllint --strict "$workflow" 2>/dev/null; then
              echo "âš ï¸  yamllint ä¸å¯ç”¨ï¼Œè·³è¿‡è¯­æ³•æ£€æŸ¥"
            fi

            # åŸºæœ¬ YAML è¯­æ³•æ£€æŸ¥
            if python3 -c "import yaml; yaml.safe_load(open('$workflow'))" 2>/dev/null; then
              echo "âœ… $workflow è¯­æ³•æ­£ç¡®"
            else
              echo "âŒ $workflow è¯­æ³•é”™è¯¯"
              exit 1
            fi
          done

      - name: Check required secrets
        run: |
          echo "ðŸ” æ£€æŸ¥å¿…è¦çš„ secrets é…ç½®..."
          echo "éœ€è¦é…ç½®çš„ secrets:"
          echo "- NPM_TOKEN: ç”¨äºŽå‘å¸ƒåŒ…åˆ° NPM"
          echo "- GITHUB_TOKEN: è‡ªåŠ¨é…ç½®ï¼Œç”¨äºŽåˆ›å»º releases"

      - name: Validate workflow dependencies
        run: |
          echo "ðŸ”— æ£€æŸ¥å·¥ä½œæµä¾èµ–å…³ç³»..."
          # æ£€æŸ¥æ˜¯å¦æœ‰å¾ªçŽ¯ä¾èµ–æˆ–å…¶ä»–é—®é¢˜
          workflows=$(find .github/workflows -name "*.yml" -exec basename {} \; | sed 's/\.yml$//')

          for workflow in $workflows; do
            echo "ðŸ“‹ å·¥ä½œæµ: $workflow"
            # æ£€æŸ¥å·¥ä½œæµæ˜¯å¦å¼•ç”¨äº†ä¸å­˜åœ¨çš„ jobs æˆ–å…¶ä»–å·¥ä½œæµ
          done

      - name: Summary
        run: |
          echo "## âœ… å·¥ä½œæµéªŒè¯å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰å·¥ä½œæµé…ç½®æ–‡ä»¶éƒ½å·²éªŒè¯é€šè¿‡ã€‚" >> $GITHUB_STEP_SUMMARY
