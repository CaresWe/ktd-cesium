# CameraPlugin - 相机控制插件

为 3D 场景提供全面的相机控制功能，包括基础的飞行、视角控制，以及高级的飞行漫游、绕点飞行等功能。

## 目录结构

```
CameraPlugin/
├── types/
│   └── index.ts          # 类型定义
├── RoamingManager.ts     # 飞行漫游管理器
├── index.ts              # 主插件文件
└── README.md             # 说明文档
```

## 核心功能

### 1. 基础相机控制

- **flyTo**: 平滑飞行到指定位置
- **setView**: 直接设置相机视角（无动画）
- **lookAt**: 环绕指定点查看
- **getCurrentPosition**: 获取当前相机位置
- **zoomToEntity**: 缩放到实体
- **flyToEntity**: 飞行到实体
- **flyToRectangle**: 飞行到矩形区域

### 2. 飞行漫游 (RoamingManager)

- **相机漫游**: 相机沿航点路径平滑飞行
- **模型漫游**: 3D 模型沿路径运动
- **绕点飞行**: 相机围绕指定点环绕
- **实时数据跟踪**: 经纬度、高程、距离、进度等
- **多种视角模式**: 跟随、俯视、侧视、自定义
- **速度控制**: 暂停/继续、速度倍率调整
- **贴地/贴模型**: 支持贴地形和贴 3D Tiles 模型

## 实现原理

### 相机漫游

1. **航点路径生成**: 使用 `SampledPositionProperty` 创建位置属性
2. **时间采样**: 根据总时长和航点数量，为每个航点分配时间戳
3. **插值算法**:
   - **Hermite 插值**: 平滑曲线，适合相机漫游（默认度数 100）
   - **Lagrange 插值**: 更自然的运动，适合模型漫游（默认度数 5）
4. **视角跟踪**: 使用 `trackedEntity` 和 `camera.lookAt` 实现视角跟随
5. **实时更新**: 通过 `scene.preUpdate` 事件监听实时位置变化

### 绕点飞行

1. **时钟控制**: 使用 Cesium Clock 系统管理时间流
2. **角度计算**: 基于时间差计算航向角变化
3. **相机定位**:
   - 设置相机中心点
   - 应用航向角和俯仰角
   - 使用 `moveBackward` 设置距离

### 实时数据采集

1. **位置追踪**: 通过实体位置获取当前坐标
2. **地形采样**: 使用 `sampleTerrainMostDetailed` 获取地面高程
3. **距离计算**: 使用 `EllipsoidGeodesic` 计算大圆距离
4. **进度计算**: 基于已飞距离和总距离计算百分比

## 技术细节

### 插值算法对比

| 算法     | 适用场景 | 度数 | 特点                     |
| -------- | -------- | ---- | ------------------------ |
| Hermite  | 相机漫游 | 100  | 曲线更平滑，适合快速移动 |
| Lagrange | 模型漫游 | 5    | 运动更自然，适合物体移动 |

### 视角模式

| 模式      | 说明     | 参数                               |
| --------- | -------- | ---------------------------------- |
| FOLLOW    | 跟随模式 | 跟踪实体，第一人称视角             |
| TOP_DOWN  | 俯视模式 | heading=0, pitch=-90               |
| SIDE_VIEW | 侧视模式 | heading=-90, pitch=-15, range=8000 |
| CUSTOM    | 自定义   | 可自定义 heading、pitch、range     |

### 性能优化

1. **航点数量**: 建议 < 50 个航点，过多会影响插值性能
2. **实时采样**: 地形高度采样使用异步处理，避免阻塞主线程
3. **事件监听**: 使用 `preUpdate` 而非 `onTick`，提高执行效率
4. **贴地/贴模型**: 按需启用，避免不必要的计算开销

## 参考来源

本插件参考了以下开源项目：

- [Cesium-Examples/Roaming.js](https://github.com/jiawanlong/Cesium-Examples) - 飞行漫游实现
- Cesium 官方文档 - SampledPositionProperty、插值算法

## 版本历史

- v2.0.0 - 重构为模块化结构，添加飞行漫游功能
- v1.0.0 - 初始版本，基础相机控制

## 作者

Auto-Cesium 团队

## 许可

MIT License
